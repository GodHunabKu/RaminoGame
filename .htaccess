# ==========================================
# ONE SERVER - .htaccess Completo
# Routing + Performance + Security
# ==========================================

# ==========================================
# URL REWRITING (FONDAMENTALI - NON TOCCARE)
# ==========================================
Options +FollowSymLinks
RewriteEngine On

RewriteCond %{SCRIPT_FILENAME} !-d
RewriteCond %{SCRIPT_FILENAME} !-f

# Users Routes
RewriteRule ^users/register/(.*)/ index.php?p=register&ref=$1
RewriteRule ^users/register/(.*) index.php?p=register&ref=$1
RewriteRule ^users/register ./index.php?p=register
RewriteRule ^users/login ./index.php?p=login
RewriteRule ^users/logout ./index.php?p=logout
RewriteRule ^users/lost/(.*)/(.*)/ ./index.php?p=lost&email=$1&code=$2
RewriteRule ^users/lost/(.*)/(.*) ./index.php?p=lost&email=$1&code=$2
RewriteRule ^users/lost ./index.php?p=lost

# News Routes
RewriteRule ^news/(.*)/(.*)/ index.php?category=$1&page_no=$2
RewriteRule ^news/(.*)/(.*) index.php?category=$1&page_no=$2
RewriteRule ^news/(.*)/ index.php?category=$1
RewriteRule ^news/(.*) index.php?category=$1
RewriteRule ^news/ index.php
RewriteRule ^news index.php

RewriteRule ^read/(.*)/ index.php?p=read&no=$1
RewriteRule ^read/(.*) index.php?p=read&no=$1

# Ranking Routes
RewriteRule ^ranking/players/(.*)/(.*)/ index.php?p=players&page_no=$1&player_name=$2
RewriteRule ^ranking/players/(.*)/(.*) index.php?p=players&page_no=$1&player_name=$2
RewriteRule ^ranking/players/(.*)/ index.php?p=players&page_no=$1
RewriteRule ^ranking/players/(.*) index.php?p=players&page_no=$1
RewriteRule ^ranking/players/ index.php?p=players
RewriteRule ^ranking/players index.php?p=players

RewriteRule ^ranking/guilds/(.*)/(.*)/ index.php?p=guilds&page_no=$1&guild_name=$2
RewriteRule ^ranking/guilds/(.*)/(.*) index.php?p=guilds&page_no=$1&guild_name=$2
RewriteRule ^ranking/guilds/(.*)/ index.php?p=guilds&page_no=$1
RewriteRule ^ranking/guilds/(.*) index.php?p=guilds&page_no=$1
RewriteRule ^ranking/guilds/ index.php?p=guilds
RewriteRule ^ranking/guilds index.php?p=guilds

# User Account Routes
RewriteRule ^user/delete/(.*)/ index.php?p=administration&code=$1
RewriteRule ^user/delete/(.*) index.php?p=administration&code=$1
RewriteRule ^user/password/(.*)/ index.php?p=password&code=$1
RewriteRule ^user/password/(.*) index.php?p=password&code=$1

RewriteRule ^user/email/(.*)/ index.php?p=email&code=$1
RewriteRule ^user/email/(.*) index.php?p=email&code=$1
RewriteRule ^user/email/ index.php?p=email&code=$1
RewriteRule ^user/email index.php?p=email&code=$1

RewriteRule ^user/administration ./index.php?p=administration
RewriteRule ^user/characters ./index.php?p=characters
RewriteRule ^user/donate index.php?p=donate

RewriteRule ^user/vote4coins/(.*)/ index.php?p=vote4coins&site=$1
RewriteRule ^user/vote4coins/(.*) index.php?p=vote4coins&site=$1
RewriteRule ^user/vote4coins ./index.php?p=vote4coins

# Admin Routes
RewriteRule ^admin/log/(.*)/(.*)/ index.php?p=admin&a=log&log=$1&page_no=$2
RewriteRule ^admin/log/(.*)/(.*) index.php?p=admin&a=log&log=$1&page_no=$2
RewriteRule ^admin/log/(.*)/ index.php?p=admin&a=log&log=$1
RewriteRule ^admin/log/(.*) index.php?p=admin&a=log&log=$1

RewriteRule ^admin/functions index.php?p=admin&a=functions
RewriteRule ^admin/createitems index.php?p=admin&a=createitems
RewriteRule ^admin/privileges index.php?p=admin&a=privileges
RewriteRule ^admin/coins index.php?p=admin&a=coins

RewriteRule ^admin/players/(.*)/(.*)/ index.php?p=admin&a=players&page_no=$1&player_name=$2
RewriteRule ^admin/players/(.*)/(.*) index.php?p=admin&a=players&page_no=$1&player_name=$2
RewriteRule ^admin/players/(.*)/ index.php?p=admin&a=players&page_no=$1
RewriteRule ^admin/players/(.*) index.php?p=admin&a=players&page_no=$1
RewriteRule ^admin/players/ index.php?p=admin&a=players
RewriteRule ^admin/players index.php?p=admin&a=players

RewriteRule ^admin/redeem/(.*)/ index.php?p=admin&a=redeem&page_no=$1
RewriteRule ^admin/redeem/(.*) index.php?p=admin&a=redeem&page_no=$1
RewriteRule ^admin/redeem/ index.php?p=admin&a=redeem
RewriteRule ^admin/redeem index.php?p=admin&a=redeem

RewriteRule ^admin/player/edit/(.*)/ index.php?p=admin&a=player_edit&id=$1
RewriteRule ^admin/player/edit/(.*) index.php?p=admin&a=player_edit&id=$1

RewriteRule ^admin/vote4coins/(.*)/ index.php?p=admin&a=vote4coins&del=$1
RewriteRule ^admin/vote4coins/(.*) index.php?p=admin&a=vote4coins&del=$1
RewriteRule ^admin/download/(.*)/ index.php?p=admin&a=download&del=$1
RewriteRule ^admin/download/(.*) index.php?p=admin&a=download&del=$1
RewriteRule ^admin/donate/(.*)/ index.php?p=admin&a=donate&del=$1
RewriteRule ^admin/donate/(.*) index.php?p=admin&a=donate&del=$1
RewriteRule ^admin/(.*)/ index.php?p=admin&a=$1
RewriteRule ^admin/(.*) index.php?p=admin&a=$1
RewriteRule ^admin/ index.php?p=admin
RewriteRule ^admin index.php?p=admin

# Other Routes
RewriteRule ^download/ index.php?p=download
RewriteRule ^download index.php?p=download

RewriteRule ^user/referrals/ index.php?p=referrals
RewriteRule ^user/referrals index.php?p=referrals

RewriteRule ^user/redeem/ index.php?p=redeem
RewriteRule ^user/redeem index.php?p=redeem

# ==========================================
# COMPRESSIONE GZIP (Performance Boost)
# ==========================================
<IfModule mod_deflate.c>
    # Comprimi HTML, CSS, JavaScript, Text, XML
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript application/x-javascript
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# ==========================================
# BROWSER CACHING (Performance Boost)
# ==========================================
<IfModule mod_expires.c>
    ExpiresActive On

    # Immagini - 1 anno
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"

    # CSS e JavaScript - 1 mese
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"

    # Font - 1 anno
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"

    # HTML - 1 ora
    ExpiresByType text/html "access plus 1 hour"

    # Default - 1 settimana
    ExpiresDefault "access plus 1 week"
</IfModule>

# ==========================================
# CACHE CONTROL HEADERS (Performance)
# ==========================================
<IfModule mod_headers.c>
    # Cache immagini per 1 anno
    <FilesMatch "\.(jpg|jpeg|png|gif|svg|webp|ico)$">
        Header set Cache-Control "max-age=31536000, public"
    </FilesMatch>

    # Cache CSS/JS per 1 mese
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "max-age=2592000, public"
    </FilesMatch>

    # Cache font per 1 anno
    <FilesMatch "\.(ttf|otf|woff|woff2|eot)$">
        Header set Cache-Control "max-age=31536000, public"
    </FilesMatch>

    # No cache per HTML/PHP
    <FilesMatch "\.(html|php)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# ==========================================
# SICUREZZA (Security Headers)
# ==========================================
<IfModule mod_headers.c>
    # Previeni clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"

    # Previeni MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"

    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Disabilita directory browsing
Options -Indexes

# Proteggi file sensibili
<FilesMatch "^(config\.php|\.env|visite\.txt|\.htaccess|\.git)">
    Order allow,deny
    Deny from all
</FilesMatch>

# ==========================================
# PHP SETTINGS (Performance & Security)
# ==========================================
<IfModule mod_php7.c>
    # Disabilita display errors in produzione
    php_flag display_errors Off

    # Abilita log errors
    php_flag log_errors On
</IfModule>

# ==========================================
# ETAGS (Performance)
# ==========================================
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None

# ==========================================
# LIMIT REQUEST SIZE (Anti-DDoS base)
# ==========================================
LimitRequestBody 10485760

# ==========================================
# PHP HANDLER (cPanel)
# ==========================================
<IfModule mime_module>
  AddHandler application/x-httpd-ea-php73 .php .php7 .phtml
</IfModule>

# ==========================================
# END
# ==========================================
